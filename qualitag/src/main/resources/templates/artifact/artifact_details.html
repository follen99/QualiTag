<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>Project details</title>
  <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Inter:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800&amp;display=swap">
  <link rel="stylesheet" href="/assets/css/Team-Horizontal-icons.css">
  <link rel="stylesheet" href="/css/homepage/custom-button.css">
  <link rel="stylesheet" href="/assets/css/Team-Horizontal-images.css">
  <!--  <link rel="stylesheet" href="/css/project/styles.css">-->
  <!--  <link rel="stylesheet" href="/css/button-styles.css">-->

  <!--  librerie per la visualizzazione del codice con Highlight.js -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
  <script
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
  <script
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/java.min.js"></script>


  <!-- script to reuse the navbar -->
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <title>Artifact Detail</title>

  <!-- Token validation -->
  <script src="/js/auth/token-validation.js"></script>

</head>
<body>
<!-- NAV BAR: THIS IS THE SAME FOR ALL THE VIEWS -->
<div id="nav-placeholder"></div>
<script>
  $(function () {
    // Carica dinamicamente il contenuto
    $("#nav-placeholder").load("/html/nav.html", function () {
      // Il contenuto è stato caricato, ora esegui il codice JavaScript
      const navBarEvent = new Event('navbarLoaded');
      console.log("navbar event dispatched");
      document.dispatchEvent(navBarEvent);

      // A questo punto, il codice JavaScript che dipende dal contenuto della navbar può essere eseguito
      // Esegui eventuali altre operazioni JavaScript per la navbar qui
    });
  });
</script>
<!--end of Navigation bar-->

<section class="py-5">
  <div class="w-auto p-3">
    <div class="row mb-4 mb-lg-5">
      <div class="row">
        <div class="col-md-8 col-xl-6 text-center mx-auto">
          <h2 class="fw-bold">Tagging the artifact</h2>
        </div>
      </div>
    </div>
    <div class="row d-flex justify-content-center">
      <div class="col-md-12 col-xl-12 d-flex justify-content-center">

        <div class="container-fluid" style="margin-left: 2em; margin-right: 2em">
          <div class="row">
            <div class="col-md-9">
              <div id="artifact-container"></div>
            </div>
            <div class="col-md-3">
              <div id="sidebar-container">
                <!-- Dropdown per selezionare i tag esistenti -->
                <div class="dropdown">
                  <button class="btn btn-secondary dropdown-toggle" type="button" id="tagDropdown"
                          data-bs-toggle="dropdown" aria-expanded="false">
                    Seleziona Tag
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="tagDropdown" id="tagList">
                    <!-- I tag verranno caricati dinamicamente qui -->
                  </ul>
                </div>

                <!-- Lista dei tag selezionati -->
                <div id="selectedTags" class="mt-3">
                  <!-- I tag selezionati verranno visualizzati qui -->
                </div>

                <!-- Pulsante per confermare i tag selezionati -->
                <button class="btn btn-primary mt-3" id="confirmTagsButton">Conferma</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</section>

<script>
  const defaultIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-app" viewBox="0 0 16 16">\n'
      + '  <path d="M11 2a3 3 0 0 1 3 3v6a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zM5 1a4 4 0 0 0-4 4v6a4 4 0 0 0 4 4h6a4 4 0 0 0 4-4V5a4 4 0 0 0-4-4z"/>\n'
      + '</svg>';

  const tagIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-tag" viewBox="0 0 16 16">\n'
      + '  <path d="M6 4.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m-1 0a.5.5 0 1 0-1 0 .5.5 0 0 0 1 0"/>\n'
      + '  <path d="M2 1h4.586a1 1 0 0 1 .707.293l7 7a1 1 0 0 1 0 1.414l-4.586 4.586a1 1 0 0 1-1.414 0l-7-7A1 1 0 0 1 1 6.586V2a1 1 0 0 1 1-1m0 5.586 7 7L13.586 9l-7-7H2z"/>\n'
      + '</svg>';

  document.addEventListener('DOMContentLoaded', function () {
    const artifactContainer = document.getElementById('artifact-container');

    // 1. Fetch the artifact from the server
    async function fetchArtifact(artifactId) {
      const artifactContainer = document.getElementById('artifact-container');

      try {
        const response = await fetch(`/api/v1/artifact/${artifactId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });

        if (!response.ok) {
          const errorResponse = await response.json();
          alert(`Error: ${errorResponse.msg}`);
          throw new Error(errorResponse.msg || 'Failed to fetch artifact');
        }

        // displaying sidebar stuff
        populateSidebar();

        // gettin headers content
        const headers = response.headers;
        const contentType = headers.get('content-type');
        const contentDisposition = headers.get('content-disposition');
        const filename = contentDisposition
            ? contentDisposition.split('filename=')[1].replace(/"/g, '')
            : 'downloaded_file';

        console.log('filename:', filename);

        // get the file as a blob
        const fileBlob = await response.blob();

        // visualize the file
        displayArtifact(fileBlob, contentType, artifactContainer);
      } catch (error) {
        artifactContainer.innerHTML = `<p>${error.message}</p>`;
      }
    }

    function populateSidebar() {
      const tagDropDown = document.getElementById('tagList');

      fetch('/api/v1/tag/byuser/' + localStorage.getItem('username') + '/all', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('authToken')}`
        }
      }).then(response => {
        if (!response.ok) {
          console.log('Error:', response);
          console.log('Error:', response.json());
        }
        return response.json();
      }).then(data => {
        if (Array.isArray(data.tags)) {
          showElementsInsideDropdown(tagDropDown, data.tags, true,
              '/api/v1/artifact/', '/tag', 'tagId', tagIcon, 'tagName');
        } else {
          const noTags = {tagName: "No tags Available"};
          showElementsInsideDropdown(tagDropDown, [noTags], false,
              '', '', '', null, 'tagName');
        }
      });

      const noTags = {tagName: "No artifacts Available"};
      showElementsInsideDropdown(tagDropDown, [noTags], false,
          '', '', '', null, 'tagName');
    }

    // 2. visualize the file
    function displayArtifact(blob, contentType, container) {
      if (contentType.startsWith('text') || contentType.includes('javascript')
          || contentType.includes('java')) {
        const reader = new FileReader();
        reader.onload = () => {
          const code = document.createElement('code');
          code.className = detectLanguage(contentType); // determine the language
          code.textContent = reader.result;

          const pre = document.createElement('pre');
          pre.appendChild(code);

          container.innerHTML = '';       // Clear existing content
          container.appendChild(pre);     // Add the new content

          hljs.highlightElement(code);    // Highlight the code wih Highlight.js
        };

        reader.readAsText(blob);
      } else if (contentType.startsWith('image')) {
        // if the file is an image
        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        img.alt = 'Artifact Image';
        img.style.maxWidth = '100%';
        container.innerHTML = '';
        img.style.borderRadius = '15px';
        img.style.boxShadow = '0 8px 16px rgba(0, 0, 0, 0.2)';
        container.appendChild(img);
      } else if (contentType === 'application/pdf') {
        // if the file is a pdf
        const object = document.createElement('object');
        object.data = URL.createObjectURL(blob);
        object.type = 'application/pdf';
        object.width = '100%';
        object.height = '500px';
        container.innerHTML = '';
        container.appendChild(object);
      } else {
        // if the file is not text, image or pdf visualize a download link
        const containerDiv = document.createElement('div');
        containerDiv.className = 'd-flex flex-column align-items-center';

        const fileTypeText = document.createElement('p');
        fileTypeText.textContent = `This is a ${contentType.split(
            '/')[1]} file. You cannot preview it.`;

        const downloadButton = document.createElement('a');
        downloadButton.href = URL.createObjectURL(blob);
        downloadButton.download = 'artifact_file';
        downloadButton.className = 'btn btn-primary d-flex align-items-center';
        downloadButton.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-file-earmark-arrow-down" viewBox="0 0 16 16" style="margin-right: 1em">
  <path d="M8.5 6.5a.5.5 0 0 0-1 0v3.793L6.354 9.146a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 10.293z"/>
  <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
</svg>
    Download
  `;

        container.innerHTML = '';
        containerDiv.appendChild(fileTypeText);
        containerDiv.appendChild(downloadButton);
        container.appendChild(containerDiv);
      }
    }

    // determine file type
    function detectLanguage(contentType) {
      if (contentType.includes('javascript')) {
        return 'language-javascript';
      }
      if (contentType.includes('java')) {
        return 'language-java';
      }
      if (contentType.includes('python')) {
        return 'language-python';
      }
      if (contentType.includes('html')) {
        return 'language-html';
      }
      if (contentType.includes('css')) {
        return 'language-css';
      }
      return 'plaintext'; // Default
    }

    // Example: Fetch and display an artifact with ID '123'
    const artifactId = window.location.pathname.split('/')[2];
    fetchArtifact(artifactId);
  });

  /**
   * Show elements inside a dropdown.
   *
   * @param targetDropdown the dropdown where the elements will be shown
   * @param list the list of elements to show
   * @param clickable if the elements are clickable
   * @param headerUrl the url to append before the id
   * @param footerUrl the url to append after the id
   * @param itemIdName the name of the id attribute
   * @param icon the icon to show before the text
   * @param attributeName the name of the attribute to show inside the dropdown
   */
  function showElementsInsideDropdown(targetDropdown,
      list,
      clickable = false,
      headerUrl,
      footerUrl,
      itemIdName,
      icon = defaultIcon,
      attributeName
  ) {
    list.forEach(listItem => {
      // Creating an element <li> for each team
      const wrapperItem = document.createElement('li');

      // Creating the <a> element
      const link = document.createElement('a');
      if (clickable) {
        link.href = headerUrl + listItem[itemIdName] + footerUrl;
      }

      link.style.textDecoration = 'none';
      link.style.color = 'inherit'; // To inherit the color from the parent

      // Creating SVG icon
      const iconElement = document.createElement('span');
      iconElement.innerHTML = icon;
      iconElement.style.marginLeft = '1em';
      iconElement.style.marginRight = '1em';

      // Adding SVG icon to <a>
      link.appendChild(iconElement);

      // Adding team
      const textToShow = document.createElement('span');
      textToShow.textContent = listItem[attributeName];
      textToShow.style.marginLeft = '0.3em';

      // Adding artifactName to <a>
      link.appendChild(textToShow);

      // Adding <a> to <li>
      wrapperItem.appendChild(link);

      // Adding <li> to dropdown
      targetDropdown.appendChild(wrapperItem);
    });
  }
</script>


<script type="module" src="/js/navbar/nav-bar-logic.js"></script>
<script src="/assets/bootstrap/js/bootstrap.min.js"></script>
<script src="/assets/js/bold-and-dark.js"></script>

</body>
</html>