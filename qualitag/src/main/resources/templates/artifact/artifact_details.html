<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>Project details</title>
  <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Inter:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800&amp;display=swap">
  <link rel="stylesheet" href="/assets/css/Team-Horizontal-icons.css">
  <link rel="stylesheet" href="/css/homepage/custom-button.css">
  <link rel="stylesheet" href="/assets/css/Team-Horizontal-images.css">
  <!--  <link rel="stylesheet" href="/css/project/styles.css">-->
  <!--  <link rel="stylesheet" href="/css/button-styles.css">-->

  <!-- script to reuse the navbar -->
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <title>Artifact Detail</title>

  <!-- Token validation -->
  <script src="/js/auth/token-validation.js"></script>

</head>
<body>
<!-- NAV BAR: THIS IS THE SAME FOR ALL THE VIEWS -->
<div id="nav-placeholder"></div>
<script>
  $(function () {
    // Carica dinamicamente il contenuto
    $("#nav-placeholder").load("/html/nav.html", function () {
      // Il contenuto è stato caricato, ora esegui il codice JavaScript
      const navBarEvent = new Event('navbarLoaded');
      console.log("navbar event dispatched");
      document.dispatchEvent(navBarEvent);

      // A questo punto, il codice JavaScript che dipende dal contenuto della navbar può essere eseguito
      // Esegui eventuali altre operazioni JavaScript per la navbar qui
    });
  });
</script>
<!--end of Navigation bar-->

<section class="py-5">
  <div class="container py-5">
    <div class="row mb-4 mb-lg-5">
      <div class="row">
        <div class="col-md-8 col-xl-6 text-center mx-auto">
          <h2 class="fw-bold">Tagging the artifact</h2>
        </div>
      </div>
    </div>
    <div class="row d-flex justify-content-center">
      <div class="col-md-12 col-xl-12">

        <div id="artifact-container"></div>

      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const artifactContainer = document.getElementById('artifact-container');

    async function fetchArtifact(artifactId) {
      const artifactContainer = document.getElementById('artifact-container');

      try {
        const response = await fetch(`/api/v1/artifact/${artifactId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });

        if (!response.ok) {
          const errorResponse = await response.json();
          alert(`Error: ${errorResponse.msg}`);
          throw new Error(errorResponse.msg || 'Failed to fetch artifact');
        }

        // Recupera il contenuto e gli headers
        const headers = response.headers;
        const contentType = headers.get('content-type');
        const contentDisposition = headers.get('content-disposition');
        const filename = contentDisposition
            ? contentDisposition.split('filename=')[1].replace(/"/g, '')
            : 'downloaded_file';

        console.log('filename:', filename);

        // Ottieni il file come Blob
        const fileBlob = await response.blob();

        // Visualizza il file in base al tipo
        displayArtifact(fileBlob, contentType, artifactContainer);
      } catch (error) {
        artifactContainer.innerHTML = `<p>${error.message}</p>`;
      }
    }

// Funzione per visualizzare il file
    function displayArtifact(blob, contentType, container) {
      if (contentType.startsWith('text')) {
        // Per i file di testo
        const reader = new FileReader();
        reader.onload = () => {
          container.innerHTML = `<pre>${reader.result}</pre>`;
        };
        reader.readAsText(blob);
      } else if (contentType.startsWith('image')) {
        // Per immagini (es. JPEG, PNG)
        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        img.alt = 'Artifact Image';
        img.style.maxWidth = '100%'; // Per evitare overflow
        container.innerHTML = ''; // Svuota il contenitore
        container.appendChild(img);
      } else if (contentType === 'application/pdf') {
        // Per file PDF
        const object = document.createElement('object');
        object.data = URL.createObjectURL(blob);
        object.type = 'application/pdf';
        object.width = '100%';
        object.height = '500px'; // Altezza del contenitore PDF
        container.innerHTML = ''; // Svuota il contenitore
        container.appendChild(object);
      } else {
        // Per altri tipi di file, offri il download
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(blob);
        downloadLink.download = 'artifact_file';
        downloadLink.textContent = 'Download File';
        container.innerHTML = ''; // Svuota il contenitore
        container.appendChild(downloadLink);
      }
    }


    // Example: Fetch and display an artifact with ID '123'
    const artifactId = window.location.pathname.split('/')[2];
    fetchArtifact(artifactId);
  });
</script>


<script type="module" src="/js/navbar/nav-bar-logic.js"></script>
<script src="/assets/bootstrap/js/bootstrap.min.js"></script>
<script src="/assets/js/bold-and-dark.js"></script>

</body>
</html>